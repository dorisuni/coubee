<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PortOne V2 ê²°ì œ í…ŒìŠ¤íŠ¸</title>
    <!-- PortOne V2 Browser SDK -->
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px; 
            line-height: 1.6;
        }
        .container { background: #f8f9fa; padding: 30px; border-radius: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        input, select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e9ecef; 
            border-radius: 6px; 
            font-size: 16px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3); }
        .btn:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        .result { 
            margin-top: 25px; 
            padding: 20px; 
            background: white; 
            border: 2px solid #e9ecef; 
            border-radius: 6px;
            white-space: pre-wrap;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .step { 
            background: white; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 6px; 
            border-left: 4px solid #007bff;
        }
        .step h3 { margin-top: 0; color: #007bff; }
        .config-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ PortOne V2 ê²°ì œ í…ŒìŠ¤íŠ¸</h1>
        
        <div class="config-box">
            <h3>âš™ï¸ V2 ì„¤ì • ê°€ì´ë“œ</h3>
            <p><strong>1.</strong> <a href="https://console.portone.io" target="_blank">PortOne ì½˜ì†”</a>ì—ì„œ V2 ê³„ì • ìƒì„±</p>
            <p><strong>2.</strong> Store IDì™€ API Secret ë°œê¸‰</p>
            <p><strong>3.</strong> ì•„ë˜ ì„¤ì • íŒŒì¼ì— ì‹¤ì œ ê°’ ì…ë ¥:</p>
            <pre>application.yml:
portone:
  v2:
    store-id: "ì‹¤ì œ_ìŠ¤í† ì–´_ID"
    api-secret: "ì‹¤ì œ_API_ì‹œí¬ë¦¿"</pre>
        </div>

        <div class="step">
            <h3>ğŸ›ï¸ 1ë‹¨ê³„: ì£¼ë¬¸ ì •ë³´ ì…ë ¥</h3>
            
            <div class="form-group">
                <label>ì‚¬ìš©ì ID:</label>
                <input type="number" id="userId" value="1">
            </div>
            
            <div class="form-group">
                <label>ë§¤ì¥ ID:</label>
                <input type="number" id="storeId" value="1">
            </div>
            
            <div class="form-group">
                <label>ìˆ˜ë ¹ì¸ ì´ë¦„:</label>
                <input type="text" id="recipientName" value="í™ê¸¸ë™">
            </div>
            
            <div class="form-group">
                <label>ê²°ì œ ë°©ë²•:</label>
                <select id="paymentMethod">
                    <option value="CARD">ì‹ ìš©ì¹´ë“œ</option>
                    <option value="KAKAOPAY">ì¹´ì¹´ì˜¤í˜ì´</option>
                    <option value="TOSSPAY">í† ìŠ¤í˜ì´</option>
                    <option value="PAYCO">í˜ì´ì½”</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>ìƒí’ˆ ID:</label>
                <input type="number" id="productId" value="1">
            </div>
            
            <div class="form-group">
                <label>ìˆ˜ëŸ‰:</label>
                <input type="number" id="quantity" value="2" min="1">
            </div>
            
            <button class="btn" onclick="startPaymentFlow()">ğŸš€ V2 ê²°ì œ í”Œë¡œìš° ì‹œì‘</button>
        </div>
        
        <div class="step">
            <h3>ğŸ“± 2ë‹¨ê³„: V2 ê²°ì œ ì§„í–‰</h3>
            <button class="btn" id="paymentBtn" onclick="proceedPayment()" disabled>
                ğŸ’³ PortOne V2 ê²°ì œ ì§„í–‰
            </button>
        </div>
        
        <div class="result" id="result"></div>
    </div>
    
    <script>
        const BASE_URL = 'http://localhost:8083';
        let currentOrder = null;
        let portoneConfig = null; // ì„¤ì •ê°’ì„ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        
        function log(message, isError = false) {
            const resultDiv = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            resultDiv.textContent += logEntry;
            resultDiv.className = `result ${isError ? 'error' : 'success'}`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
            
            console.log(message);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì •ê°’ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        async function fetchPaymentConfig() {
            try {
                log('âš™ï¸ ë°±ì—”ë“œì—ì„œ ê²°ì œ ì„¤ì • ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤...');
                const response = await fetch(`${BASE_URL}/api/payments/config`);
                if (!response.ok) {
                    throw new Error('ì„¤ì • ì •ë³´ ë¡œë”© ì‹¤íŒ¨');
                }
                const configResponse = await response.json();
                portoneConfig = configResponse.data;
                log(`âœ… ê²°ì œ ì„¤ì • ë¡œë“œ ì™„ë£Œ!`);
                log(`   Store ID: ${portoneConfig.storeId}`);
                log(`   ì‚¬ìš© ê°€ëŠ¥í•œ ê²°ì œ ìˆ˜ë‹¨: ${Object.keys(portoneConfig.channelKeys).join(', ')}`);
            } catch (error) {
                log(`âŒ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, true);
                throw error;
            }
        }
        
        async function startPaymentFlow() {
            try {
                document.getElementById('result').textContent = '';
                log('ğŸš€ PortOne V2 ê²°ì œ í”Œë¡œìš°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...');
                
                // 0ë‹¨ê³„: ê²°ì œ ì„¤ì • ì •ë³´ ë¡œë“œ
                await fetchPaymentConfig();
                
                // 1ë‹¨ê³„: ë°±ì—”ë“œì—ì„œ ì£¼ë¬¸ ìƒì„±
                await createOrder();
                
                // 2ë‹¨ê³„: ê²°ì œ ë²„íŠ¼ ë°”ë¡œ í™œì„±í™” (preparePayment ë‹¨ê³„ ì œê±°)
                if (currentOrder) { // ì£¼ë¬¸ ìƒì„±ì´ ì„±ê³µí–ˆì„ ë•Œë§Œ
                    document.getElementById('paymentBtn').disabled = false;
                    log('âœ… ì£¼ë¬¸ ìƒì„± ì™„ë£Œ! ì´ì œ "PortOne V2 ê²°ì œ ì§„í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
                }
                
            } catch (error) {
                log(`âŒ ì—ëŸ¬ ë°œìƒ: ${error.message}`, true);
            }
        }
        
        async function createOrder() {
            const orderData = {
                storeId: parseInt(document.getElementById('storeId').value),
                recipientName: document.getElementById('recipientName').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                items: [{
                    productId: parseInt(document.getElementById('productId').value),
                    quantity: parseInt(document.getElementById('quantity').value)
                }]
            };
            
            log('ğŸ“ ì£¼ë¬¸ ìƒì„± ì¤‘...');
            
            const response = await fetch(`${BASE_URL}/api/orders`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': document.getElementById('userId').value
                },
                body: JSON.stringify(orderData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨ (${response.status}): ${errorText}`);
            }
            
            currentOrder = await response.json();
            log(`âœ… ì£¼ë¬¸ ìƒì„± ì„±ê³µ!`);
            log(`   ì£¼ë¬¸ ID: ${currentOrder.data.orderId}`);
            log(`   ê²°ì œ ID: ${currentOrder.data.paymentId}`);
            log(`   ê¸ˆì•¡: ${currentOrder.data.amount.toLocaleString()}ì›`);
        }
        
        
        async function proceedPayment() {
            if (!currentOrder) {
                log('âŒ ì£¼ë¬¸ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € ì£¼ë¬¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  í”Œë¡œìš°ë¥¼ ì‹œì‘í•˜ì„¸ìš”.', true);
                return;
            }
            
            if (!portoneConfig) {
                log('âŒ ê²°ì œ ì„¤ì • ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. í”Œë¡œìš°ë¥¼ ë‹¤ì‹œ ì‹œì‘í•´ì£¼ì„¸ìš”.', true);
                return;
            }
            
            try {
                log('ğŸ¯ PortOne V2 ê²°ì œì°½ì„ í˜¸ì¶œí•©ë‹ˆë‹¤...');
                
                // PortOne V2 ê²°ì œ ìš”ì²­
                if (!window.PortOne) {
                    throw new Error('PortOne V2 SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                // ì„ íƒëœ ê²°ì œ ìˆ˜ë‹¨ì— ë§ëŠ” ì±„ë„ í‚¤ ë™ì  ì¡°íšŒ
                const selectedPayMethodKey = document.getElementById('paymentMethod').value;
                const channelKey = portoneConfig.channelKeys[selectedPayMethodKey.toLowerCase()];

                if (!channelKey) {
                    log(`âŒ ì„¤ì • ì˜¤ë¥˜: '${selectedPayMethodKey}'ì— ëŒ€í•œ ì±„ë„ í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, true);
                    log('ğŸ’¡ application.ymlê³¼ ì±„ë„ í‚¤ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.', true);
                    return;
                }
                
                log(`   - ìŠ¤í† ì–´ ID: ${portoneConfig.storeId}`);
                log(`   - ì±„ë„ í‚¤ (${selectedPayMethodKey}): ${channelKey}`);
                log(`   - ê²°ì œ ID: ${currentOrder.data.paymentId}`);

                const response = await window.PortOne.requestPayment({
                    // Store ID
                    storeId: portoneConfig.storeId,
                    
                    // ì±„ë„ í‚¤ (ì–´ë–¤ ê²°ì œì°½ì„ ë„ìš¸ì§€ ê²°ì •)
                    channelKey: channelKey,
                    
                    // ì£¼ë¬¸ ì •ë³´
                    paymentId: currentOrder.data.paymentId,
                    orderName: currentOrder.data.orderName,
                    totalAmount: currentOrder.data.amount,
                    currency: "KRW",
                    
                    // êµ¬ë§¤ì ì •ë³´
                    customer: {
                        fullName: currentOrder.data.buyerName,
                        phoneNumber: "010-1234-5678", // í…ŒìŠ¤íŠ¸ìš© ë²ˆí˜¸
                        email: "test@example.com" // í…ŒìŠ¤íŠ¸ìš© ì´ë©”ì¼
                    },

                    // ê²°ì œ ìˆ˜ë‹¨ (PortOneì—ì„œ í•„ìˆ˜ íŒŒë¼ë¯¸í„°)
                    payMethod: selectedPayMethodKey,
                    
                    // ì½œë°± URL
                    redirectUrl: `${window.location.origin}/payment-complete?orderId=${currentOrder.data.orderId}`,
                    notificationUrls: [`${BASE_URL}/api/payments/webhook`]
                });
                
                // ê²°ì œ ê²°ê³¼ ì²˜ë¦¬
                if (response.code != null) {
                    // ê²°ì œ ì‹¤íŒ¨
                    log(`âŒ ê²°ì œ ì‹¤íŒ¨: ${response.message}`, true);
                } else {
                    // ê²°ì œ ì„±ê³µ
                    log(`ğŸ‰ ê²°ì œ ì„±ê³µ!`);
                    log(`   ê²°ì œ ID: ${response.paymentId}`);
                    log(`   ê±°ë˜ ID: ${response.txId}`);
                    
                    // ë°±ì—”ë“œì— ê²°ì œ ì™„ë£Œ ì•Œë¦¼ (ì›¹í›… ëŒ€ì‹  ì§ì ‘ í˜¸ì¶œ)
                    await notifyPaymentComplete(response.paymentId);
                }
                
            } catch (error) {
                if (error.message.includes('PortOne') || error.message.includes('SDK')) {
                    log('âš ï¸ PortOne V2 SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.', true);
                    log('ğŸ’¡ ì‹¤ì œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë‹¤ìŒì´ í•„ìš”í•©ë‹ˆë‹¤:', true);
                    log('   1. PortOne ì½˜ì†”ì—ì„œ V2 ê³„ì • ìƒì„±', true);
                    log('   2. Store IDì™€ Channel Key ë°œê¸‰', true);
                    log('   3. application.ymlì— ì‹¤ì œ ì„¤ì •ê°’ ì…ë ¥', true);
                } else {
                    log(`âŒ ê²°ì œ ê³¼ì •ì—ì„œ ì˜¤ë¥˜: ${error.message}`, true);
                }
            }
        }
        
        async function notifyPaymentComplete(paymentId) {
            try {
                log('ğŸ“ ê²°ì œ ì™„ë£Œë¥¼ ë°±ì—”ë“œì— ì•Œë¦½ë‹ˆë‹¤...');
                
                const response = await fetch(`${BASE_URL}/api/payments/webhook?paymentId=${paymentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    log('âœ… ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ ì„±ê³µ!');
                } else {
                    log('âš ï¸ ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                }
                
            } catch (error) {
                log(`âš ï¸ ë°±ì—”ë“œ í†µì‹  ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // PortOne V2 SDK ë¡œë“œ í™•ì¸
        function checkPortOneSDK() {
            if (typeof window.PortOne !== 'undefined') {
                log('âœ… PortOne V2 SDK ë¡œë“œ ì™„ë£Œ!');
                return true;
            } else {
                log('âŒ PortOne V2 SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', true);
                log('ğŸ’¡ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ë³´ì„¸ìš”.', true);
                return false;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            log('ğŸ”§ PortOne V2 í…ŒìŠ¤íŠ¸ í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            log('ğŸ“‹ 1ë‹¨ê³„: ì£¼ë¬¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  "V2 ê²°ì œ í”Œë¡œìš° ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
            
            // 2ì´ˆ í›„ SDK ë¡œë“œ í™•ì¸
            setTimeout(checkPortOneSDK, 2000);
        });
    </script>
</body>
</html>