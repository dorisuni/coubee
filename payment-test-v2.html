<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PortOne V2 결제 테스트</title>
    <!-- PortOne V2 Browser SDK -->
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px; 
            line-height: 1.6;
        }
        .container { background: #f8f9fa; padding: 30px; border-radius: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        input, select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e9ecef; 
            border-radius: 6px; 
            font-size: 16px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3); }
        .btn:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        .result { 
            margin-top: 25px; 
            padding: 20px; 
            background: white; 
            border: 2px solid #e9ecef; 
            border-radius: 6px;
            white-space: pre-wrap;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .step { 
            background: white; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 6px; 
            border-left: 4px solid #007bff;
        }
        .step h3 { margin-top: 0; color: #007bff; }
        .config-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        /* QR 모달 스타일 */
        .qr-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .qr-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .qr-modal-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .qr-modal-header h2 {
            margin: 0;
            font-size: 24px;
        }
        
        .qr-close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        .qr-close:hover {
            opacity: 0.7;
        }
        
        .qr-modal-body {
            padding: 30px;
            text-align: center;
        }
        
        .qr-modal-body h3 {
            color: #495057;
            margin-bottom: 10px;
        }
        
        .qr-modal-body p {
            color: #6c757d;
            margin-bottom: 20px;
        }
        
        .qr-container {
            background: white;
            border: 3px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: inline-block;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .qr-container img {
            max-width: 250px;
            width: 100%;
            height: auto;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .qr-container img:hover {
            transform: scale(1.05);
        }
        
        .order-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        
        .order-info p {
            margin: 8px 0;
            font-size: 16px;
            color: #495057;
        }
        
        .order-info strong {
            color: #212529;
        }
        
        .qr-actions {
            margin-top: 20px;
        }
        
        .qr-instruction {
            font-size: 14px;
            color: #6c757d;
            margin: 8px 0;
            font-style: italic;
        }
        
        .qr-tip {
            font-size: 16px;
            color: #28a745;
            font-weight: 600;
            margin: 12px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 PortOne V2 결제 테스트</h1>
        
        <div class="config-box">
            <h3>⚙️ V2 설정 가이드</h3>
            <p><strong>1.</strong> <a href="https://console.portone.io" target="_blank">PortOne 콘솔</a>에서 V2 계정 생성</p>
            <p><strong>2.</strong> Store ID와 API Secret 발급</p>
            <p><strong>3.</strong> 아래 설정 파일에 실제 값 입력:</p>
            <pre>application.yml:
portone:
  v2:
    store-id: "실제_스토어_ID"
    api-secret: "실제_API_시크릿"</pre>
        </div>

        <div class="step">
            <h3>🔐 사용자 인증</h3>
            <div class="form-group">
                <label>테스트 사용자 선택:</label>
                <select id="userTypeSelect" onchange="switchUserType(this.value)">
                    <option value="user">일반 사용자 (test_user)</option>
                    <option value="admin">관리자 (test_admin)</option>
                    <option value="superAdmin">슈퍼 관리자 (test_super_admin)</option>
                </select>
            </div>
        </div>

        <div class="step">
            <h3>🛍️ 1단계: 주문 정보 입력</h3>
            
            <div class="form-group">
                <label>사용자 ID:</label>
                <input type="number" id="userId" value="1" readonly>
            </div>
            
            <div class="form-group">
                <label>매장 ID:</label>
                <input type="number" id="storeId" value="1">
            </div>
            
            <div class="form-group">
                <label>수령인 이름:</label>
                <input type="text" id="recipientName" value="홍길동">
            </div>
            
            <div class="form-group">
                <label>결제 방법:</label>
                <select id="paymentMethod">
                    <option value="CARD">신용카드</option>
                    <option value="KAKAOPAY">카카오페이</option>
                    <option value="TOSSPAY">토스페이</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>상품 ID:</label>
                <input type="number" id="productId" value="1">
            </div>
            
            <div class="form-group">
                <label>수량:</label>
                <input type="number" id="quantity" value="2" min="1">
            </div>
            
            <button class="btn" onclick="startPaymentFlow()">🚀 V2 결제 플로우 시작</button>
        </div>
        
        <div class="step">
            <h3>📱 2단계: V2 결제 진행</h3>
            <button class="btn" id="paymentBtn" onclick="proceedPayment()" disabled>
                💳 PortOne V2 결제 진행
            </button>
        </div>

        <div class="step">
            <h3>🧪 3단계: API 테스트 도구들</h3>
            
            <div class="form-group">
                <label>QR 토큰으로 주문 조회:</label>
                <input type="text" id="qrToken" placeholder="QR 토큰 입력">
                <button class="btn" onclick="lookupOrderByQr()">🔍 QR로 주문 찾기</button>
            </div>
            
            <div class="form-group">
                <label>주문 ID로 수령 등록:</label>
                <input type="text" id="receiveOrderId" placeholder="주문 ID 입력">
                <button class="btn" onclick="receiveOrder()">📦 수령 등록</button>
            </div>
            
            <div class="form-group">
                <label>사용자 주문 목록 조회:</label>
                <button class="btn" onclick="getUserOrders()">📋 내 주문 목록 보기</button>
            </div>
            
            <div class="form-group">
                <label>결제 상태 조회:</label>
                <input type="text" id="paymentStatusId" placeholder="결제 ID 입력">
                <button class="btn" onclick="getPaymentStatus()">💳 결제 상태 확인</button>
            </div>
            
            <div class="form-group">
                <label>주문 상태 수동 변경 (관리자):</label>
                <input type="text" id="updateOrderId" placeholder="주문 ID 입력">
                <select id="newOrderStatus">
                    <option value="PENDING">PENDING (결제 대기)</option>
                    <option value="PAID">PAID (결제 완료)</option>
                    <option value="PREPARING">PREPARING (준비 중)</option>
                    <option value="PREPARED">PREPARED (준비 완료)</option>
                    <option value="RECEIVED">RECEIVED (수령 완료)</option>
                    <option value="CANCELLED">CANCELLED (취소)</option>
                    <option value="FAILED">FAILED (실패)</option>
                </select>
                <button class="btn" onclick="updateOrderStatus()">⚙️ 상태 변경</button>
            </div>
        </div>
        
        <div class="result" id="result"></div>
        
        <!-- QR 코드 모달 -->
        <div id="qrModal" class="qr-modal" style="display: none;">
            <div class="qr-modal-content">
                <div class="qr-modal-header">
                    <h2>🎉 결제 완료!</h2>
                    <span class="qr-close" onclick="closeQrModal()">&times;</span>
                </div>
                <div class="qr-modal-body">
                    <h3>📱 수령용 QR 코드</h3>
                    <p>매장에서 이 QR 코드를 보여주세요</p>
                    <div class="qr-container">
                        <img id="qrCodeImage" src="" alt="QR Code" />
                    </div>
                    <div class="order-info">
                        <p><strong>주문 ID:</strong> <span id="modalOrderId"></span></p>
                        <p><strong>수령인:</strong> <span id="modalRecipient"></span></p>
                        <p><strong>결제 금액:</strong> <span id="modalAmount"></span>원</p>
                    </div>
                    <div class="qr-actions">
                        <p class="qr-instruction">💡 화면을 캡처하거나 우클릭으로 이미지를 저장하세요</p>
                        <p class="qr-tip">🏪 매장에서 QR 코드를 스캔하여 주문을 수령하세요</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const BASE_URL = 'https://dorisuni.store';
        let currentOrder = null;
        let portoneConfig = null; // 설정값을 저장할 전역 변수
        
        // 테스트용 JWT 토큰들 (15분간 유효)
        const TEST_TOKENS = {
            user: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJjb3ViZWUiLCJzdWIiOiJ0ZXN0X3VzZXIiLCJ1c2VySWQiOiIxIiwidXNlcm5hbWUiOiJ0ZXN0X3VzZXIiLCJuaWNrbmFtZSI6Iu2FjOyKpO2KuOycoOyggCIsInJvbGUiOiJST0xFX1VTRVIiLCJ0b2tlblR5cGUiOiJhY2Nlc3MiLCJpYXQiOjE3NTMyNTk4NzEsImV4cCI6MTc1MzI2MDc3MX0.JvowuiBj8mMcl6-z1d21rAcs2BaeSfHn-4VN8Aa5USg',
            admin: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJjb3ViZWUiLCJzdWIiOiJ0ZXN0X2FkbWluIiwidXNlcklkIjoiMiIsInVzZXJuYW1lIjoidGVzdF9hZG1pbiIsIm5pY2tuYW1lIjoi7YWM7Iqk7Yq47KCQ7J6lIiwicm9sZSI6IlJPTEVfQURNSU4iLCJ0b2tlblR5cGUiOiJhY2Nlc3MiLCJpYXQiOjE3NTMyNTk4NzEsImV4cCI6MTc1MzI2MDc3MX0.S6VXM5Qi-hLTjmzbOJ81LAiOs_NbmHEteEAoB1CI_xQ',
            superAdmin: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJjb3ViZWUiLCJzdWIiOiJ0ZXN0X3N1cGVyX2FkbWluIiwidXNlcklkIjoiMyIsInVzZXJuYW1lIjoidGVzdF9zdXBlcl9hZG1pbiIsIm5pY2tuYW1lIjoi7YWM7Iqk7Yq46rSA66as7J6QIiwicm9sZSI6IlJPTEVfU1VQRVJfQURNSU4iLCJ0b2tlblR5cGUiOiJhY2Nlc3MiLCJpYXQiOjE3NTMyNTk4NzEsImV4cCI6MTc1MzI2MDc3MX0.x3se640zW94XVkIm11c91c2w4rAobTbvgdXnBgnVYh4'
        };
        
        // 현재 선택된 사용자 유형
        let currentUserType = 'user';
        
        // 인증 헤더 생성 함수
        function getAuthHeaders() {
            const token = TEST_TOKENS[currentUserType];
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }
        
        // 사용자 타입 변경 함수
        function switchUserType(userType) {
            currentUserType = userType;
            const userId = userType === 'user' ? '1' : userType === 'admin' ? '2' : '3';
            document.getElementById('userId').value = userId;
            log(`🔄 사용자 타입 변경: ${userType} (ID: ${userId})`);
        }
        
        function log(message, isError = false) {
            const resultDiv = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            resultDiv.textContent += logEntry;
            resultDiv.className = `result ${isError ? 'error' : 'success'}`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
            
            console.log(message);
        }

        /**
         * PortOne V2 API에 맞는 payMethod 값으로 변환
         */
        function getPortOnePayMethod(paymentMethod) {
            const payMethodMap = {
                'CARD': 'CARD',
                'KAKAOPAY': 'EASY_PAY',
                'TOSSPAY': 'EASY_PAY', 
                'PAYCO': 'EASY_PAY'
            };
            
            return payMethodMap[paymentMethod] || paymentMethod;
        }

        // 페이지 로드 시 설정값 가져오는 함수
        async function fetchPaymentConfig() {
            try {
                log('⚙️ 백엔드에서 결제 설정 정보를 가져옵니다...');
                const response = await fetch(`${BASE_URL}/api/payments/config`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) {
                    throw new Error('설정 정보 로딩 실패');
                }
                const configResponse = await response.json();
                portoneConfig = configResponse.data;
                log(`✅ 결제 설정 로드 완료!`);
                log(`   Store ID: ${portoneConfig.storeId}`);
                log(`   사용 가능한 결제 수단: ${Object.keys(portoneConfig.channelKeys).join(', ')}`);
            } catch (error) {
                log(`❌ 설정 로드 실패: ${error.message}`, true);
                throw error;
            }
        }
        
        async function startPaymentFlow() {
            try {
                document.getElementById('result').textContent = '';
                log('🚀 PortOne V2 결제 플로우를 시작합니다...');
                
                // 0단계: 결제 설정 정보 로드
                await fetchPaymentConfig();
                
                // 1단계: 백엔드에서 주문 생성
                await createOrder();
                
                // 2단계: 결제 버튼 바로 활성화 (preparePayment 단계 제거)
                if (currentOrder) { // 주문 생성이 성공했을 때만
                    document.getElementById('paymentBtn').disabled = false;
                    log('✅ 주문 생성 완료! 이제 "PortOne V2 결제 진행" 버튼을 클릭하세요.');
                }
                
            } catch (error) {
                log(`❌ 에러 발생: ${error.message}`, true);
            }
        }
        
        async function createOrder() {
            const orderData = {
                storeId: parseInt(document.getElementById('storeId').value),
                recipientName: document.getElementById('recipientName').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                items: [{
                    productId: parseInt(document.getElementById('productId').value),
                    quantity: parseInt(document.getElementById('quantity').value)
                }]
            };
            
            log('📝 주문 생성 중...');
            
            const headers = getAuthHeaders();
            headers['X-User-ID'] = document.getElementById('userId').value;
            
            const response = await fetch(`${BASE_URL}/api/orders`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(orderData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`주문 생성 실패 (${response.status}): ${errorText}`);
            }
            
            currentOrder = await response.json();
            log(`✅ 주문 생성 성공!`);
            log(`   주문 ID: ${currentOrder.data.orderId}`);
            log(`   결제 ID: ${currentOrder.data.paymentId}`);
            log(`   금액: ${currentOrder.data.amount.toLocaleString()}원`);
        }
        
        
        async function proceedPayment() {
            if (!currentOrder) {
                log('❌ 주문이 생성되지 않았습니다. 먼저 주문 정보를 입력하고 플로우를 시작하세요.', true);
                return;
            }
            
            if (!portoneConfig) {
                log('❌ 결제 설정 정보가 없습니다. 플로우를 다시 시작해주세요.', true);
                return;
            }
            
            try {
                log('🎯 PortOne V2 결제창을 호출합니다...');
                
                // PortOne V2 결제 요청
                if (!window.PortOne) {
                    throw new Error('PortOne V2 SDK가 로드되지 않았습니다.');
                }
                
                // 선택된 결제 수단에 맞는 채널 키 동적 조회
                const selectedPayMethodKey = document.getElementById('paymentMethod').value;
                // ⭐ toLowerCase()를 추가하여 소문자 키로 조회
                const channelKey = portoneConfig.channelKeys[selectedPayMethodKey.toLowerCase()];
                
                // PortOne V2 API에 맞는 payMethod 변환
                const portOnePayMethod = getPortOnePayMethod(selectedPayMethodKey);

                if (!channelKey) {
                    log(`❌ 설정 오류: '${selectedPayMethodKey}'에 대한 채널 키를 찾을 수 없습니다.`, true);
                    log('💡 application.yml과 채널 키 설정을 확인하세요.', true);
                    return;
                }
                
                log(`   - 스토어 ID: ${portoneConfig.storeId}`);
                log(`   - 채널 키 (${selectedPayMethodKey}): ${channelKey}`);
                log(`   - 결제 ID: ${currentOrder.data.paymentId}`);
                log(`   - PayMethod: ${selectedPayMethodKey} → ${portOnePayMethod}`);

                // ⭐ 최종적으로 PortOne에 보낼 데이터 객체 - 백엔드로부터 받은 값으로 전부 채워넣기
                const paymentData = {
                    // Store ID (필수)
                    storeId: portoneConfig.storeId,
                    
                    // 채널 키 (어떤 결제창을 띄울지 결정) (필수)
                    channelKey: channelKey,
                    
                    // ======== 백엔드로부터 받은 값으로 전부 채워넣기 ========
                    paymentId: currentOrder.data.paymentId,          // 백엔드에서 생성한 고유 결제 ID
                    orderName: currentOrder.data.orderName,          // 백엔드에서 생성한 주문명 
                    totalAmount: currentOrder.data.amount,           // 백엔드에서 계산한 총 금액
                    // ===============================================
                    
                    // 통화 (필수)
                    currency: "KRW",
                    
                    // 결제 수단 (필수) 
                    payMethod: portOnePayMethod,
                    
                    // 구매자 정보 (권장) - 백엔드에서 받은 값 우선 사용
                    customer: {
                        fullName: currentOrder.data.buyerName,       // 백엔드에서 받은 구매자명
                        phoneNumber: "010-1234-5678",               // 테스트용 번호
                        email: "test@example.com"                   // 테스트용 이메일
                    },

                    // 결제 완료 후 리다이렉트 URL (선택사항)
                    redirectUrl: `${window.location.origin}/payment-complete?orderId=${currentOrder.data.orderId}`,
                    
                    // 웹훅 URL (선택사항)
                    notificationUrls: [`${BASE_URL}/api/payments/webhook`]
                };

                log('🔍 결제 요청 데이터:');
                console.log('Payment Request Data:', paymentData);

                const response = await window.PortOne.requestPayment(paymentData);
                
                // 결제 결과 처리
                if (response.code != null) {
                    // 결제 실패
                    log(`❌ 결제 실패: ${response.message}`, true);
                } else {
                    // 결제 성공
                    log(`🎉 결제 성공!`);
                    log(`   결제 ID: ${response.paymentId}`);
                    log(`   거래 ID: ${response.txId}`);
                    
                    // 백엔드에 결제 완료 알림 (웹훅 대신 직접 호출)
                    await notifyPaymentComplete(response.paymentId);
                    
                    // 수령 QR 코드 표시
                    await showPickupQrCode(currentOrder.data.orderId);
                }
                
            } catch (error) {
                if (error.message.includes('PortOne') || error.message.includes('SDK')) {
                    log('⚠️ PortOne V2 SDK가 로드되지 않았거나 설정이 필요합니다.', true);
                    log('💡 실제 테스트를 위해 다음이 필요합니다:', true);
                    log('   1. PortOne 콘솔에서 V2 계정 생성', true);
                    log('   2. Store ID와 Channel Key 발급', true);
                    log('   3. application.yml에 실제 설정값 입력', true);
                } else {
                    log(`❌ 결제 과정에서 오류: ${error.message}`, true);
                }
            }
        }
        
        async function notifyPaymentComplete(paymentId) {
            try {
                log('📞 결제 완료를 백엔드에 알립니다...');
                
                const response = await fetch(`${BASE_URL}/api/payments/webhook?paymentId=${paymentId}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    log('✅ 결제 완료 처리 성공!');
                } else {
                    log('⚠️ 결제 완료 처리 중 오류 발생');
                }
                
            } catch (error) {
                log(`⚠️ 백엔드 통신 오류: ${error.message}`);
            }
        }
        
        // QR 코드 모달 표시
        async function showPickupQrCode(orderId) {
            try {
                log('📱 수령 QR 코드를 생성합니다...');
                
                // 주문 정보 다시 조회하여 최신 상태 확인
                const headers = getAuthHeaders();
                headers['X-User-ID'] = document.getElementById('userId').value;
                
                const orderResponse = await fetch(`${BASE_URL}/api/orders/${orderId}`, {
                    headers: headers
                });
                
                if (!orderResponse.ok) {
                    throw new Error('주문 정보 조회 실패');
                }
                
                const orderData = await orderResponse.json();
                const order = orderData.data;
                
                // QR 코드 이미지 URL 생성
                const qrImageUrl = `${BASE_URL}/api/qr/orders/${orderId}/image?t=${Date.now()}`;
                
                // 모달에 정보 설정
                document.getElementById('qrCodeImage').src = qrImageUrl;
                document.getElementById('modalOrderId').textContent = orderId;
                document.getElementById('modalRecipient').textContent = order.recipientName;
                document.getElementById('modalAmount').textContent = order.totalAmount.toLocaleString();
                
                // 모달 표시
                document.getElementById('qrModal').style.display = 'block';
                
                log('✅ 수령 QR 코드가 생성되었습니다!');
                log('💡 QR 코드를 매장에서 스캔하여 주문을 수령하세요.');
                
            } catch (error) {
                log(`❌ QR 코드 생성 실패: ${error.message}`, true);
            }
        }
        
        // QR 코드 모달 닫기
        function closeQrModal() {
            document.getElementById('qrModal').style.display = 'none';
        }
        
        
        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('qrModal');
            if (event.target === modal) {
                closeQrModal();
            }
        }
        
        // PortOne V2 SDK 로드 확인
        function checkPortOneSDK() {
            if (typeof window.PortOne !== 'undefined') {
                log('✅ PortOne V2 SDK 로드 완료!');
                return true;
            } else {
                log('❌ PortOne V2 SDK가 로드되지 않았습니다.', true);
                log('💡 네트워크 연결을 확인하거나 페이지를 새로고침 해보세요.', true);
                return false;
            }
        }

        // QR 토큰으로 주문 조회
        async function lookupOrderByQr() {
            const qrToken = document.getElementById('qrToken').value.trim();
            if (!qrToken) {
                log('❌ QR 토큰을 입력하세요.', true);
                return;
            }
            
            try {
                log(`🔍 QR 토큰으로 주문을 조회합니다: ${qrToken}`);
                
                const response = await fetch(`${BASE_URL}/api/qr/lookup/${qrToken}`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`조회 실패 (${response.status}): ${await response.text()}`);
                }
                
                const orderData = await response.json();
                log('✅ QR 조회 성공!');
                log(`   주문 ID: ${orderData.orderId}`);
                log(`   상태: ${orderData.status}`);
                log(`   수령인: ${orderData.recipientName}`);
                log(`   금액: ${orderData.totalAmount.toLocaleString()}원`);
                
                // 조회된 주문 ID를 수령 등록 필드에 자동 입력
                document.getElementById('receiveOrderId').value = orderData.orderId;
                
            } catch (error) {
                log(`❌ QR 조회 실패: ${error.message}`, true);
            }
        }
        
        // 주문 수령 등록
        async function receiveOrder() {
            const orderId = document.getElementById('receiveOrderId').value.trim();
            if (!orderId) {
                log('❌ 주문 ID를 입력하세요.', true);
                return;
            }
            
            try {
                log(`📦 주문 수령을 등록합니다: ${orderId}`);
                
                const response = await fetch(`${BASE_URL}/api/orders/${orderId}/receive`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`수령 등록 실패 (${response.status}): ${await response.text()}`);
                }
                
                const result = await response.json();
                log('✅ 수령 등록 성공!');
                log(`   주문 ID: ${result.data.orderId}`);
                log(`   새 상태: ${result.data.status}`);
                log(`   수령인: ${result.data.recipientName}`);
                
            } catch (error) {
                log(`❌ 수령 등록 실패: ${error.message}`, true);
            }
        }
        
        // 사용자 주문 목록 조회
        async function getUserOrders() {
            const userId = document.getElementById('userId').value;
            
            try {
                log(`📋 사용자 ${userId}의 주문 목록을 조회합니다...`);
                
                const headers = getAuthHeaders();
                headers['X-User-ID'] = userId;
                
                const response = await fetch(`${BASE_URL}/api/users/${userId}/orders?page=0&size=10`, {
                    headers: headers
                });
                
                if (!response.ok) {
                    throw new Error(`조회 실패 (${response.status}): ${await response.text()}`);
                }
                
                const result = await response.json();
                const orders = result.data.orders;
                
                log('✅ 주문 목록 조회 성공!');
                log(`   총 주문 수: ${result.data.totalCount}개`);
                
                if (orders.length === 0) {
                    log('   📋 주문 내역이 없습니다.');
                } else {
                    orders.forEach((order, index) => {
                        log(`   ${index + 1}. ${order.orderId} - ${order.status} - ${order.totalAmount.toLocaleString()}원`);
                    });
                }
                
            } catch (error) {
                log(`❌ 주문 목록 조회 실패: ${error.message}`, true);
            }
        }
        
        // 결제 상태 조회
        async function getPaymentStatus() {
            const paymentId = document.getElementById('paymentStatusId').value.trim();
            if (!paymentId) {
                log('❌ 결제 ID를 입력하세요.', true);
                return;
            }
            
            try {
                log(`💳 결제 상태를 조회합니다: ${paymentId}`);
                
                const response = await fetch(`${BASE_URL}/api/payments/${paymentId}/status`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`조회 실패 (${response.status}): ${await response.text()}`);
                }
                
                const result = await response.json();
                log('✅ 결제 상태 조회 성공!');
                log(JSON.stringify(result.data, null, 2));
                
            } catch (error) {
                log(`❌ 결제 상태 조회 실패: ${error.message}`, true);
            }
        }
        
        // 주문 상태 수동 변경 (관리자용)
        async function updateOrderStatus() {
            const orderId = document.getElementById('updateOrderId').value.trim();
            const newStatus = document.getElementById('newOrderStatus').value;
            
            if (!orderId) {
                log('❌ 주문 ID를 입력하세요.', true);
                return;
            }
            
            try {
                log(`⚙️ 주문 상태를 변경합니다: ${orderId} → ${newStatus}`);
                
                const response = await fetch(`${BASE_URL}/api/orders/${orderId}`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        status: newStatus
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`상태 변경 실패 (${response.status}): ${await response.text()}`);
                }
                
                const result = await response.json();
                log('✅ 주문 상태 변경 성공!');
                log(`   주문 ID: ${result.data.orderId}`);
                log(`   이전 상태: ${result.data.previousStatus}`);
                log(`   현재 상태: ${result.data.currentStatus}`);
                log(`   변경 시각: ${result.data.updatedAt}`);
                
            } catch (error) {
                log(`❌ 주문 상태 변경 실패: ${error.message}`, true);
            }
        }

        // 페이지 로드 시 초기화
        window.addEventListener('load', function() {
            log('🔧 PortOne V2 테스트 페이지가 로드되었습니다.');
            log('🔐 현재 사용자: 일반 사용자 (test_user, ID: 1)');
            log('💡 다른 권한으로 테스트하려면 사용자 인증 섹션에서 변경하세요.');
            log('📋 1단계: 주문 정보를 입력하고 "V2 결제 플로우 시작" 버튼을 클릭하세요.');
            
            // 2초 후 SDK 로드 확인
            setTimeout(checkPortOneSDK, 2000);
        });
    </script>
</body>
</html>