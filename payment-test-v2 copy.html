<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PortOne V2 ê²°ì œ í…ŒìŠ¤íŠ¸ (ë¡œê·¸ì¸ ê¸°ëŠ¥ ì¶”ê°€)</title>
    <!-- PortOne V2 Browser SDK -->
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
    <style>
        /* CSS ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìƒëµí•©ë‹ˆë‹¤. */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px; 
            line-height: 1.6;
        }
        .container { background: #f8f9fa; padding: 30px; border-radius: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        input, select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e9ecef; 
            border-radius: 6px; 
            font-size: 16px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3); }
        .btn:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        .result { 
            margin-top: 25px; 
            padding: 20px; 
            background: white; 
            border: 2px solid #e9ecef; 
            border-radius: 6px;
            white-space: pre-wrap;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .step { 
            background: white; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 6px; 
            border-left: 4px solid #007bff;
        }
        .step h3 { margin-top: 0; color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ PortOne V2 ê²°ì œ í…ŒìŠ¤íŠ¸ (ë¡œê·¸ì¸ ê¸°ëŠ¥)</h1>
        
        <div class="step">
            <h3>ğŸ“ íšŒì›ê°€ì…</h3>
            <div class="form-group">
                <label>ì•„ì´ë””:</label>
                <input type="text" id="registerUsername" placeholder="ì‚¬ìš©í•  ì•„ì´ë””">
            </div>
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸:</label>
                <input type="password" id="registerPassword" placeholder="ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸">
            </div>
            <div class="form-group">
                <label>ë‹‰ë„¤ì„:</label>
                <input type="text" id="registerNickname" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„">
            </div>
            <button class="btn" onclick="handleRegister()" style="background: #17a2b8;">ğŸ“ íšŒì›ê°€ì…</button>
        </div>

        <div class="step">
            <h3>ğŸ” ì‚¬ìš©ì ì¸ì¦</h3>
            <div class="form-group">
                <label>ì•„ì´ë””:</label>
                <input type="text" id="loginUsername" value="test_user" placeholder="test_user, test_admin ë“±">
            </div>
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸:</label>
                <input type="password" id="loginPassword" value="1234">
            </div>
            <button class="btn" onclick="handleLogin()" style="background: #28a745;">ğŸ”‘ ë¡œê·¸ì¸ (í† í° ë°œê¸‰)</button>
            <p id="loginStatus" style="margin-top: 10px; font-weight: bold;"></p>
        </div>

        <div class="step">
            <h3>âš™ï¸ ê²°ì œ ì„¤ì • ì •ë³´ ì¡°íšŒ</h3>
            <button class="btn" onclick="testFetchPaymentConfig()" style="background: #17a2b8;">ğŸ”§ ê²°ì œ ì„¤ì • ì •ë³´ë§Œ ê°€ì ¸ì˜¤ê¸°</button>
        </div>

        <div class="step">
            <h3>ğŸ›ï¸ 1ë‹¨ê³„: ì£¼ë¬¸ ì •ë³´ ì…ë ¥</h3>
            <!-- ì£¼ë¬¸ ì •ë³´ ì…ë ¥ í•„ë“œë“¤ì€ ì´ì „ê³¼ ë™ì¼ -->
            <div class="form-group">
                <label>ì‚¬ìš©ì ID (ë¡œê·¸ì¸ ì‹œ ìë™ ì„¤ì •):</label>
                <input type="number" id="userId" readonly>
            </div>
            <div class="form-group">
                <label>ë§¤ì¥ ID:</label>
                <input type="number" id="storeId" value="1">
            </div>
            <div class="form-group">
                <label>ìˆ˜ë ¹ì¸ ì´ë¦„:</label>
                <input type="text" id="recipientName" value="í™ê¸¸ë™">
            </div>
            <div class="form-group">
                <label>ê²°ì œ ë°©ë²•:</label>
                <select id="paymentMethod">
                    <option value="CARD">ì‹ ìš©ì¹´ë“œ</option>
                    <option value="KAKAOPAY">ì¹´ì¹´ì˜¤í˜ì´</option>
                    <option value="TOSSPAY">í† ìŠ¤í˜ì´</option>
                </select>
            </div>
            <div class="form-group">
                <label>ìƒí’ˆ ID:</label>
                <input type="number" id="productId" value="1">
            </div>
            <div class="form-group">
                <label>ìˆ˜ëŸ‰:</label>
                <input type="number" id="quantity" value="2" min="1">
            </div>
            <button class="btn" onclick="startPaymentFlow()">ğŸš€ V2 ê²°ì œ í”Œë¡œìš° ì‹œì‘</button>
        </div>
        
        <div class="step">
            <h3>ğŸ“± 2ë‹¨ê³„: V2 ê²°ì œ ì§„í–‰</h3>
            <button class="btn" id="paymentBtn" onclick="proceedPayment()" disabled>
                ğŸ’³ PortOne V2 ê²°ì œ ì§„í–‰
            </button>
        </div>
        
        <div class="result" id="result"></div>
    </div>
    
    <script>
        const BASE_URL = 'http://127.0.0.1:39425';  // Gateway URL
        let currentOrder = null;
        let portoneConfig = null;

        // Base64ë¥¼ UTF-8ë¡œ ì•ˆì „í•˜ê²Œ ë””ì½”ë”©í•˜ëŠ” í•¨ìˆ˜ (JWT payload í™•ì¸ìš©)
        function base64ToUtf8(str) {
            return decodeURIComponent(escape(atob(str)));
        }

        // ë¡œê·¸ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateLoginStatus() {
            const token = sessionStorage.getItem('accessToken');
            const statusEl = document.getElementById('loginStatus');
            if (token) {
                try {
                    const payloadBase64 = token.split('.')[1];
                    const payload = JSON.parse(base64ToUtf8(payloadBase64));
                    const exp = payload.exp * 1000; // ms ë‹¨ìœ„ë¡œ ë³€í™˜
                    
                    statusEl.textContent = `âœ… ë¡œê·¸ì¸ë¨: ${payload.username} (ë§Œë£Œ: ${new Date(exp).toLocaleString()})`;
                    statusEl.style.color = '#28a745';
                    
                    // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ IDë¥¼ ì£¼ë¬¸ ì •ë³´ì— ìë™ ì„¤ì •
                    document.getElementById('userId').value = payload.userId;
                } catch (e) {
                    statusEl.textContent = 'âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”.';
                    statusEl.style.color = '#ffc107';
                }
            } else {
                statusEl.textContent = 'âŒ ë¡œê·¸ì•„ì›ƒ ìƒíƒœì…ë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                statusEl.style.color = '#dc3545';
                document.getElementById('userId').value = '';
            }
        }

        // íšŒì›ê°€ì… ì²˜ë¦¬ í•¨ìˆ˜
        async function handleRegister() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const nickName = document.getElementById('registerNickname').value;

            try {
                log(`ğŸ“ íšŒì›ê°€ì…ì„ ì‹œë„í•©ë‹ˆë‹¤: ${username}`);
                const response = await fetch(`${BASE_URL}/api/user/auth/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ username, password, nickName, role: 'USER' }),
                    mode: 'cors',
                    credentials: 'omit'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`íšŒì›ê°€ì… ì‹¤íŒ¨ (${response.status}): ${errorData.message}`);
                }

                log('âœ… íšŒì›ê°€ì… ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');

            } catch (error) {
                log(`âŒ íšŒì›ê°€ì… ì˜¤ë¥˜: ${error.message}`, true);
            }
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                log(`ğŸ”‘ ë¡œê·¸ì¸ì„ ì‹œë„í•©ë‹ˆë‹¤: ${username}`);
                const response = await fetch(`${BASE_URL}/api/user/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ username, password }),
                    mode: 'cors',
                    credentials: 'omit'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`ë¡œê·¸ì¸ ì‹¤íŒ¨ (${response.status}): ${errorData.message}`);
                }

                const result = await response.json();
                const accessToken = result.data.access.token;

                // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— í† í° ì €ì¥
                sessionStorage.setItem('accessToken', accessToken);
                
                log('âœ… ë¡œê·¸ì¸ ì„±ê³µ! Access Tokenì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.');
                updateLoginStatus();

            } catch (error) {
                log(`âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}`, true);
                sessionStorage.removeItem('accessToken');
                updateLoginStatus();
            }
        }
        
        // ì¸ì¦ í—¤ë” ìƒì„± í•¨ìˆ˜ (ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì •)
        function getAuthHeaders() {
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                log('âŒ ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.', true);
                throw new Error('ì¸ì¦ í† í° ì—†ìŒ');
            }
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                // CORS ê´€ë ¨ í—¤ë” ëª…ì‹œì  ì¶”ê°€
                'Accept': 'application/json'
            };
        }
        
        function log(message, isError = false) {
            const resultDiv = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            resultDiv.textContent += logEntry;
            resultDiv.className = `result ${isError ? 'error' : 'success'}`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
            
            console.log(message);
        }

        // PortOne V2 APIì— ë§ëŠ” payMethod ê°’ìœ¼ë¡œ ë³€í™˜
        function getPortOnePayMethod(paymentMethod) {
            const payMethodMap = { 'CARD': 'CARD', 'KAKAOPAY': 'EASY_PAY', 'TOSSPAY': 'EASY_PAY' };
            return payMethodMap[paymentMethod] || paymentMethod;
        }

        // ê²°ì œ ì„¤ì • ì •ë³´ë§Œ í…ŒìŠ¤íŠ¸í•˜ëŠ” í•¨ìˆ˜
        async function testFetchPaymentConfig() {
            try {
                document.getElementById('result').textContent = '';
                log('ğŸ”§ ê²°ì œ ì„¤ì • ì •ë³´ë§Œ ê°€ì ¸ì˜¤ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...');

                await fetchPaymentConfig();

                if (portoneConfig) {
                    log('âœ… ê²°ì œ ì„¤ì • ì •ë³´ í…ŒìŠ¤íŠ¸ ì„±ê³µ!');
                    log(`ğŸ“‹ Store ID: ${portoneConfig.storeId}`);
                    log(`ğŸ“‹ Channel Keys: ${JSON.stringify(portoneConfig.channelKeys, null, 2)}`);
                } else {
                    log('âŒ ê²°ì œ ì„¤ì • ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', true);
                }
            } catch (error) {
                log(`âŒ ê²°ì œ ì„¤ì • ì •ë³´ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, true);
            }
        }

        // ê²°ì œ ì„¤ì • ì •ë³´ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (Fallback ë¡œì§ ì œê±°)
        async function fetchPaymentConfig() {
            log('âš™ï¸ ë°±ì—”ë“œì—ì„œ ê²°ì œ ì„¤ì • ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤...');

            const response = await fetch(`${BASE_URL}/api/order/payment/config`, {
                method: 'GET',
                // headers: getAuthHeaders(),
                // mode: 'cors',
                // credentials: 'omit'  // í† í°ì„ í—¤ë”ë¡œ ë³´ë‚´ë¯€ë¡œ credentialsëŠ” omit
            });

            // ì„œë²„ ì‘ë‹µ ìƒì„¸ ë¡œê¹…
            console.log('ğŸ” fetchPaymentConfig ì‘ë‹µ ìƒì„¸:', {
                status: response.status,
                statusText: response.statusText,
                headers: Object.fromEntries(response.headers.entries()),
                url: response.url
            });

            if (response.status === 403) {
                const errorText = await response.text();
                console.log('âŒ 403 ì‘ë‹µ ë³¸ë¬¸:', errorText);
                log('âŒ ê²Œì´íŠ¸ì›¨ì´ ì¸ì¦ ì‹¤íŒ¨ (403 Forbidden). JWT í† í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', true);
                log('ğŸ’¡ í•´ê²° ë°©ë²•: ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì—¬ ìƒˆë¡œìš´ í† í°ì„ ë°œê¸‰ë°›ìœ¼ì„¸ìš”.', true);
                throw new Error(`ì¸ì¦ ì‹¤íŒ¨ (${response.status})`);
            }

            if (!response.ok) {
                const errorText = await response.text();
                log(`âŒ ì„¤ì • ì •ë³´ ë¡œë”© ì‹¤íŒ¨ (${response.status}): ${errorText}`, true);
                throw new Error(`ì„¤ì • ì •ë³´ ë¡œë”© ì‹¤íŒ¨ (${response.status})`);
            }

            const configResponse = await response.json();
            portoneConfig = configResponse.data;
            log(`âœ… ê²°ì œ ì„¤ì • ë¡œë“œ ì™„ë£Œ! Store ID: ${portoneConfig.storeId}`);
        }
        
        async function startPaymentFlow() {
            try {
                document.getElementById('result').textContent = '';
                log('ğŸš€ PortOne V2 ê²°ì œ í”Œë¡œìš°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...');
                
                // 1ë‹¨ê³„: ê²°ì œ ì„¤ì • ì •ë³´ ë¡œë“œ (ë‚´ë¶€ì—ì„œ ì¸ì¦ í—¤ë” ì‚¬ìš©)
                await fetchPaymentConfig();
                
                // 2ë‹¨ê³„: ë°±ì—”ë“œì—ì„œ ì£¼ë¬¸ ìƒì„±
                await createOrder();
                
                if (currentOrder) {
                    document.getElementById('paymentBtn').disabled = false;
                    log('âœ… ì£¼ë¬¸ ìƒì„± ì™„ë£Œ! ì´ì œ "PortOne V2 ê²°ì œ ì§„í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
                }
            } catch (error) {
                log(`âŒ ì—ëŸ¬ ë°œìƒ: ${error.message}`, true);
            }
        }
        
        async function createOrder() {
            const orderData = {
                storeId: parseInt(document.getElementById('storeId').value),
                recipientName: document.getElementById('recipientName').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                items: [{
                    productId: parseInt(document.getElementById('productId').value),
                    quantity: parseInt(document.getElementById('quantity').value)
                }]
            };
            
            log('ğŸ“ ì£¼ë¬¸ ìƒì„± ì¤‘...');
            
            const headers = getAuthHeaders(); // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ í† í°ìœ¼ë¡œ í—¤ë” ìƒì„±
            
            const response = await fetch(`${BASE_URL}/api/order/orders`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(orderData),
                mode: 'cors',
                credentials: 'omit'  // í† í°ì„ í—¤ë”ë¡œ ë³´ë‚´ë¯€ë¡œ credentialsëŠ” omit
            });

            // ì„œë²„ ì‘ë‹µ ìƒì„¸ ë¡œê¹…
            console.log('ğŸ” createOrder ì‘ë‹µ ìƒì„¸:', {
                status: response.status,
                statusText: response.statusText,
                headers: Object.fromEntries(response.headers.entries()),
                url: response.url
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.log(`âŒ ${response.status} ì‘ë‹µ ë³¸ë¬¸:`, errorText);
                throw new Error(`ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨ (${response.status}): ${errorText}`);
            }

            currentOrder = await response.json();
            console.log('âœ… ì£¼ë¬¸ ìƒì„± ì‘ë‹µ ë°ì´í„°:', currentOrder);
            log(`âœ… ì£¼ë¬¸ ìƒì„± ì„±ê³µ! ì£¼ë¬¸ ID: ${currentOrder.data.orderId}, ê¸ˆì•¡: ${currentOrder.data.amount}ì›`);
        }

        async function proceedPayment() {
            // ì´ í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤.
            if (!currentOrder || !portoneConfig) {
                log('âŒ ì£¼ë¬¸ ë˜ëŠ” ê²°ì œ ì„¤ì • ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. í”Œë¡œìš°ë¥¼ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.', true);
                return;
            }
            
            try {
                log('ğŸ¯ PortOne V2 ê²°ì œì°½ì„ í˜¸ì¶œí•©ë‹ˆë‹¤...');
                const selectedPayMethodKey = document.getElementById('paymentMethod').value;
                const channelKey = portoneConfig.channelKeys[selectedPayMethodKey.toLowerCase()];
                const portOnePayMethod = getPortOnePayMethod(selectedPayMethodKey);

                if (!channelKey) {
                    log(`âŒ ì„¤ì • ì˜¤ë¥˜: '${selectedPayMethodKey}'ì— ëŒ€í•œ ì±„ë„ í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, true);
                    return;
                }

                const paymentData = {
                    storeId: portoneConfig.storeId,
                    channelKey: channelKey,
                    paymentId: currentOrder.data.paymentId,
                    orderName: currentOrder.data.orderName,
                    totalAmount: currentOrder.data.amount,
                    currency: "KRW",
                    payMethod: portOnePayMethod,
                    customer: {
                        fullName: currentOrder.data.buyerName,
                        phoneNumber: "010-1234-5678",
                        email: "test@example.com"
                    },
                    redirectUrl: `${window.location.origin}/payment-complete?orderId=${currentOrder.data.orderId}`,
                    notificationUrls: [`${BASE_URL}/api/order/webhook/portone`]
                };

                const response = await window.PortOne.requestPayment(paymentData);
                
                if (response.code != null) {
                    log(`âŒ ê²°ì œ ì‹¤íŒ¨: ${response.message}`, true);
                } else {
                    log(`ğŸ‰ ê²°ì œ ì„±ê³µ! ê²°ì œ ID: ${response.paymentId}`);
                }
            } catch (error) {
                log(`âŒ ê²°ì œ ê³¼ì •ì—ì„œ ì˜¤ë¥˜: ${error.message}`, true);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            log('ğŸ”§ PortOne V2 í…ŒìŠ¤íŠ¸ í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            log('ğŸ’¡ ë¨¼ì € í…ŒìŠ¤íŠ¸ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì—¬ í† í°ì„ ë°œê¸‰ë°›ìœ¼ì„¸ìš”.');
            updateLoginStatus(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            
            // SDK ë¡œë“œ í™•ì¸
            if (typeof window.PortOne !== 'undefined') {
                log('âœ… PortOne V2 SDK ë¡œë“œ ì™„ë£Œ!');
            } else {
                log('âŒ PortOne V2 SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', true);
            }
        });
    </script>
</body>
</html>